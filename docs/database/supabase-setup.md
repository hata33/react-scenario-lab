# Supabase 数据库设置指南

本文档介绍如何在 Supabase 中设置项目所需的数据库表结构和安全策略。

## 📋 目录

- [快速开始](#快速开始)
- [表结构](#表结构)
- [安全策略](#安全策略)
- [性能优化](#性能优化)
- [故障排除](#故障排除)

## 🚀 快速开始

### 1. 创建 todos 表

在 Supabase 控制台的 SQL 编辑器中执行以下 SQL：

```sql
-- 创建 todos 表
CREATE TABLE todos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    is_complete BOOLEAN DEFAULT FALSE,
    priority INTEGER DEFAULT 1 CHECK (priority >= 1 AND priority <= 5),
    due_date TIMESTAMP WITH TIME ZONE,
    tags TEXT[] DEFAULT '{}'
);
```

### 2. 创建索引

```sql
-- 创建索引以提高查询性能
CREATE INDEX idx_todos_user_id ON todos(user_id);
CREATE INDEX idx_todos_created_at ON todos(created_at DESC);
CREATE INDEX idx_todos_is_complete ON todos(is_complete);
CREATE INDEX idx_todos_priority ON todos(priority);
CREATE INDEX idx_todos_due_date ON todos(due_date);
CREATE INDEX idx_todos_tags ON todos USING GIN(tags);
```

### 3. 启用行级安全策略 (RLS)

```sql
-- 启用行级安全策略
ALTER TABLE todos ENABLE ROW LEVEL SECURITY;

-- 创建安全策略：用户只能操作自己的 todos
CREATE POLICY "Users can view their own todos" ON todos
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own todos" ON todos
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own todos" ON todos
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own todos" ON todos
    FOR DELETE USING (auth.uid() = user_id);
```

### 4. 创建触发器

```sql
-- 创建自动更新 updated_at 字段的触发器
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER handle_todos_updated_at
    BEFORE UPDATE ON todos
    FOR EACH ROW
    EXECUTE FUNCTION handle_updated_at();
```

## 📊 表结构详细说明

### todos 表

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `id` | BIGINT | PRIMARY KEY | 自增 | 唯一标识符 |
| `created_at` | TIMESTAMPTZ | NOT NULL | NOW() | 创建时间 |
| `updated_at` | TIMESTAMPTZ | NOT NULL | NOW() | 最后更新时间 |
| `user_id` | UUID | NOT NULL, FK | - | 用户ID，关联 auth.users |
| `title` | VARCHAR(255) | NOT NULL | - | Todo 标题 |
| `description` | TEXT | - | NULL | Todo 详细描述 |
| `is_complete` | BOOLEAN | - | FALSE | 是否已完成 |
| `priority` | INTEGER | CHECK(1-5) | 1 | 优先级 (1-5) |
| `due_date` | TIMESTAMPTZ | - | NULL | 截止日期 |
| `tags` | TEXT[] | - | '{}' | 标签数组 |

### 优先级说明

| 值 | 说明 | 颜色 |
|----|------|------|
| 1 | 低 | 🟢 绿色 |
| 2 | 中 | 🔵 蓝色 |
| 3 | 高 | 🟡 黄色 |
| 4 | 紧急 | 🟠 橙色 |
| 5 | 非常紧急 | 🔴 红色 |

## 🔐 安全策略

### 行级安全策略 (RLS)

项目使用 Supabase 的行级安全策略来确保数据安全：

1. **用户隔离**：每个用户只能访问自己的 todos
2. **权限控制**：细粒度的 CRUD 操作权限
3. **数据完整性**：防止跨用户数据访问

### 安全策略详解

```sql
-- 查看所有安全策略
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename = 'todos';
```

## ⚡ 性能优化

### 索引策略

- `idx_todos_user_id`：快速按用户查询
- `idx_todos_created_at`：按时间排序
- `idx_todos_is_complete`：按完成状态筛选
- `idx_todos_priority`：按优先级筛选
- `idx_todos_due_date`：按截止日期筛选
- `idx_todos_tags`：支持标签搜索 (GIN 索引)

### 查询优化建议

```sql
-- 推荐的查询模式
SELECT * FROM todos
WHERE user_id = auth.uid()
  AND is_complete = false
ORDER BY priority DESC, created_at DESC
LIMIT 20;
```

## 🔧 环境配置

### 环境变量

确保 `.env.local` 文件包含正确的 Supabase 配置：

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### TypeScript 类型

对应的 TypeScript 类型定义在 `src/types/todo.ts`：

```typescript
export interface Todo {
    id: number
    created_at: string
    user_id: string
    title: string
    description?: string
    is_complete: boolean
    priority: number
    due_date?: string
    tags: string[]
    updated_at: string
}
```

## 🐛 故障排除

### 常见问题

1. **权限错误**
   ```sql
   -- 检查 RLS 是否启用
   SELECT schemaname, tablename, rowsecurity
   FROM pg_tables
   WHERE tablename = 'todos';
   ```

2. **用户无法访问数据**
   ```sql
   -- 检查安全策略
   SELECT * FROM pg_policies WHERE tablename = 'todos';
   ```

3. **性能问题**
   ```sql
   -- 检查查询计划
   EXPLAIN ANALYZE SELECT * FROM todos WHERE user_id = $1;
   ```

### 调试技巧

1. **查看当前用户**：
   ```sql
   SELECT auth.uid();
   ```

2. **检查表结构**：
   ```sql
   \d todos
   ```

3. **监控查询性能**：
   ```sql
   SELECT query, calls, total_time, mean_time
   FROM pg_stat_statements
   WHERE query LIKE '%todos%'
   ORDER BY total_time DESC;
   ```

## 📚 相关文档

- [Supabase 官方文档](https://supabase.com/docs)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Next.js 数据库集成](https://nextjs.org/docs/app/building-your-application/data-fetching)

## 🔄 版本历史

- **v1.0.0** (2025-10-19): 初始版本，支持基本的 Todo CRUD 功能
- 包含行级安全策略和性能优化索引

## 🤝 贡献

如果需要修改数据库结构，请：

1. 先在开发环境测试
2. 更新此文档
3. 通知团队成员相关变更
4. 考虑数据迁移策略

---

**注意**：在生产环境中，请确保定期备份数据库，并监控性能指标。