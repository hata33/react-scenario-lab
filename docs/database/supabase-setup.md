# Supabase æ•°æ®åº“è®¾ç½®æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ Supabase ä¸­è®¾ç½®é¡¹ç›®æ‰€éœ€çš„æ•°æ®åº“è¡¨ç»“æž„å’Œå®‰å…¨ç­–ç•¥ã€‚

## ðŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¡¨ç»“æž„](#è¡¨ç»“æž„)
- [å®‰å…¨ç­–ç•¥](#å®‰å…¨ç­–ç•¥)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æ•…éšœæŽ’é™¤](#æ•…éšœæŽ’é™¤)

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»º todos è¡¨

åœ¨ Supabase æŽ§åˆ¶å°çš„ SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- åˆ›å»º todos è¡¨
CREATE TABLE todos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    is_complete BOOLEAN DEFAULT FALSE,
    priority INTEGER DEFAULT 1 CHECK (priority >= 1 AND priority <= 5),
    due_date TIMESTAMP WITH TIME ZONE,
    tags TEXT[] DEFAULT '{}'
);
```

### 2. åˆ›å»ºç´¢å¼•

```sql
-- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_todos_user_id ON todos(user_id);
CREATE INDEX idx_todos_created_at ON todos(created_at DESC);
CREATE INDEX idx_todos_is_complete ON todos(is_complete);
CREATE INDEX idx_todos_priority ON todos(priority);
CREATE INDEX idx_todos_due_date ON todos(due_date);
CREATE INDEX idx_todos_tags ON todos USING GIN(tags);
```

### 3. å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
ALTER TABLE todos ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºå®‰å…¨ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„ todos
CREATE POLICY "Users can view their own todos" ON todos
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own todos" ON todos
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own todos" ON todos
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own todos" ON todos
    FOR DELETE USING (auth.uid() = user_id);
```

### 4. åˆ›å»ºè§¦å‘å™¨

```sql
-- åˆ›å»ºè‡ªåŠ¨æ›´æ–° updated_at å­—æ®µçš„è§¦å‘å™¨
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER handle_todos_updated_at
    BEFORE UPDATE ON todos
    FOR EACH ROW
    EXECUTE FUNCTION handle_updated_at();
```

## ðŸ“Š è¡¨ç»“æž„è¯¦ç»†è¯´æ˜Ž

### todos è¡¨

| å­—æ®µå | ç±»åž‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜Ž |
|--------|------|------|--------|------|
| `id` | BIGINT | PRIMARY KEY | è‡ªå¢ž | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `created_at` | TIMESTAMPTZ | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMPTZ | NOT NULL | NOW() | æœ€åŽæ›´æ–°æ—¶é—´ |
| `user_id` | UUID | NOT NULL, FK | - | ç”¨æˆ·IDï¼Œå…³è” auth.users |
| `title` | VARCHAR(255) | NOT NULL | - | Todo æ ‡é¢˜ |
| `description` | TEXT | - | NULL | Todo è¯¦ç»†æè¿° |
| `is_complete` | BOOLEAN | - | FALSE | æ˜¯å¦å·²å®Œæˆ |
| `priority` | INTEGER | CHECK(1-5) | 1 | ä¼˜å…ˆçº§ (1-5) |
| `due_date` | TIMESTAMPTZ | - | NULL | æˆªæ­¢æ—¥æœŸ |
| `tags` | TEXT[] | - | '{}' | æ ‡ç­¾æ•°ç»„ |

### ä¼˜å…ˆçº§è¯´æ˜Ž

| å€¼ | è¯´æ˜Ž | é¢œè‰² |
|----|------|------|
| 1 | ä½Ž | ðŸŸ¢ ç»¿è‰² |
| 2 | ä¸­ | ðŸ”µ è“è‰² |
| 3 | é«˜ | ðŸŸ¡ é»„è‰² |
| 4 | ç´§æ€¥ | ðŸŸ  æ©™è‰² |
| 5 | éžå¸¸ç´§æ€¥ | ðŸ”´ çº¢è‰² |

## ðŸ” å®‰å…¨ç­–ç•¥

### è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)

é¡¹ç›®ä½¿ç”¨ Supabase çš„è¡Œçº§å®‰å…¨ç­–ç•¥æ¥ç¡®ä¿æ•°æ®å®‰å…¨ï¼š

1. **ç”¨æˆ·éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ todos
2. **æƒé™æŽ§åˆ¶**ï¼šç»†ç²’åº¦çš„ CRUD æ“ä½œæƒé™
3. **æ•°æ®å®Œæ•´æ€§**ï¼šé˜²æ­¢è·¨ç”¨æˆ·æ•°æ®è®¿é—®

### å®‰å…¨ç­–ç•¥è¯¦è§£

```sql
-- æŸ¥çœ‹æ‰€æœ‰å®‰å…¨ç­–ç•¥
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename = 'todos';
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ç­–ç•¥

- `idx_todos_user_id`ï¼šå¿«é€ŸæŒ‰ç”¨æˆ·æŸ¥è¯¢
- `idx_todos_created_at`ï¼šæŒ‰æ—¶é—´æŽ’åº
- `idx_todos_is_complete`ï¼šæŒ‰å®ŒæˆçŠ¶æ€ç­›é€‰
- `idx_todos_priority`ï¼šæŒ‰ä¼˜å…ˆçº§ç­›é€‰
- `idx_todos_due_date`ï¼šæŒ‰æˆªæ­¢æ—¥æœŸç­›é€‰
- `idx_todos_tags`ï¼šæ”¯æŒæ ‡ç­¾æœç´¢ (GIN ç´¢å¼•)

### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

```sql
-- æŽ¨èçš„æŸ¥è¯¢æ¨¡å¼
SELECT * FROM todos
WHERE user_id = auth.uid()
  AND is_complete = false
ORDER BY priority DESC, created_at DESC
LIMIT 20;
```

## ðŸ”§ çŽ¯å¢ƒé…ç½®

### çŽ¯å¢ƒå˜é‡

ç¡®ä¿ `.env.local` æ–‡ä»¶åŒ…å«æ­£ç¡®çš„ Supabase é…ç½®ï¼š

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### TypeScript ç±»åž‹

å¯¹åº”çš„ TypeScript ç±»åž‹å®šä¹‰åœ¨ `src/types/todo.ts`ï¼š

```typescript
export interface Todo {
    id: number
    created_at: string
    user_id: string
    title: string
    description?: string
    is_complete: boolean
    priority: number
    due_date?: string
    tags: string[]
    updated_at: string
}
```

## ðŸ› æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **æƒé™é”™è¯¯**
   ```sql
   -- æ£€æŸ¥ RLS æ˜¯å¦å¯ç”¨
   SELECT schemaname, tablename, rowsecurity
   FROM pg_tables
   WHERE tablename = 'todos';
   ```

2. **ç”¨æˆ·æ— æ³•è®¿é—®æ•°æ®**
   ```sql
   -- æ£€æŸ¥å®‰å…¨ç­–ç•¥
   SELECT * FROM pg_policies WHERE tablename = 'todos';
   ```

3. **æ€§èƒ½é—®é¢˜**
   ```sql
   -- æ£€æŸ¥æŸ¥è¯¢è®¡åˆ’
   EXPLAIN ANALYZE SELECT * FROM todos WHERE user_id = $1;
   ```

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹å½“å‰ç”¨æˆ·**ï¼š
   ```sql
   SELECT auth.uid();
   ```

2. **æ£€æŸ¥è¡¨ç»“æž„**ï¼š
   ```sql
   \d todos
   ```

3. **ç›‘æŽ§æŸ¥è¯¢æ€§èƒ½**ï¼š
   ```sql
   SELECT query, calls, total_time, mean_time
   FROM pg_stat_statements
   WHERE query LIKE '%todos%'
   ORDER BY total_time DESC;
   ```

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)
- [Next.js æ•°æ®åº“é›†æˆ](https://nextjs.org/docs/app/building-your-application/data-fetching)

## ðŸ”„ ç‰ˆæœ¬åŽ†å²

- **v1.0.0** (2025-10-19): åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬çš„ Todo CRUD åŠŸèƒ½
- åŒ…å«è¡Œçº§å®‰å…¨ç­–ç•¥å’Œæ€§èƒ½ä¼˜åŒ–ç´¢å¼•

## ðŸ¤ è´¡çŒ®

å¦‚æžœéœ€è¦ä¿®æ”¹æ•°æ®åº“ç»“æž„ï¼Œè¯·ï¼š

1. å…ˆåœ¨å¼€å‘çŽ¯å¢ƒæµ‹è¯•
2. æ›´æ–°æ­¤æ–‡æ¡£
3. é€šçŸ¥å›¢é˜Ÿæˆå‘˜ç›¸å…³å˜æ›´
4. è€ƒè™‘æ•°æ®è¿ç§»ç­–ç•¥

---

**æ³¨æ„**ï¼šåœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ï¼Œè¯·ç¡®ä¿å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼Œå¹¶ç›‘æŽ§æ€§èƒ½æŒ‡æ ‡ã€‚