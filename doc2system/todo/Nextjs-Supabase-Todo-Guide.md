# Next.js + Supabase Todo 系统完整指南

## 📋 目录
1. [环境准备](#环境准备)
2. [项目初始化](#项目初始化)
3. [Supabase 配置](#supabase-配置)
4. [数据库设计](#数据库设计)
5. [认证系统](#认证系统)
6. [CRUD 操作](#crud-操作)
7. [实时同步](#实时同步)
8. [部署配置](#部署配置)

## 🚀 环境准备

### 必需条件
- Node.js 18+
- pnpm 包管理器
- Supabase 账户
- Vercel 账户（推荐部署）

### 依赖包安装
```bash
# 核心依赖
pnpm add @supabase/supabase-js @supabase/ssr @supabase/auth-ui-react @supabase/auth-ui-shared

# 类型定义
pnpm add -D @types/node

# 额外工具（可选）
pnpm add @supabase/postgrest-js
```

## 🏗️ 项目初始化

### 1. 创建 Next.js 项目
```bash
pnpm create next-app@latest my-supabase-todo --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
cd my-supabase-todo
```

### 2. 环境变量配置
创建 `.env.local` 文件：
```env
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# 认证配置
NEXT_PUBLIC_SUPABASE_REDIRECT_URL=http://localhost:3000/auth/callback
```

### 3. Supabase 客户端配置
创建 `src/lib/supabase.ts`：
```typescript
import { createClient } from '@supabase/supabase-js'
import { cookies } from 'next/headers'

// 客户端组件使用
export function createClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// 服务端组件使用
export async function createServerClient() {
  const cookieStore = cookies()
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )
}

// 直接导出（兼容性）
export const supabase = createClient()
```

## 🗄️ Supabase 配置

### 1. 数据库表设计
在 Supabase SQL 编辑器中执行：

```sql
-- 用户表
create table profiles (
  id uuid references auth.users not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  website text,
  constraint username_length check (char_length(username) >= 3)
);

-- Todo 表
create table todos (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  title text not null,
  description text,
  is_complete boolean default false,
  priority integer default 1 check (priority between 1 and 5),
  due_date timestamp with time zone,
  tags text[],
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- 设置 RLS (Row Level Security)
alter table profiles enable row level security;
alter table todos enable row level security;

-- 用户只能访问自己的数据
create policy "Users can view own profile." on profiles for select using (auth.uid() = id);
create policy "Users can update own profile." on profiles for update using (auth.uid() = id);

create policy "Users can view own todos." on todos for select using (auth.uid() = user_id);
create policy "Users can insert own todos." on todos for insert with check (auth.uid() = user_id);
create policy "Users can update own todos." on todos for update using (auth.uid() = user_id);
create policy "Users can delete own todos." on todos for delete using (auth.uid() = user_id);

-- 创建索引优化查询
create index on todos (user_id, is_complete);
create index on todos (due_date);
create index on todos (created_at);
```

### 2. 存储桶配置（用于头像上传）
```sql
-- 创建头像存储桶
insert into storage.buckets (id, name, public)
values ('avatars', 'avatars', true);

-- 设置头像上传权限
create policy "Avatar images are publicly accessible." on storage.objects for select using (bucket_id = 'avatars');
create policy "Users can upload their own avatar." on storage.objects for insert with check (bucket_id = 'avatars' and auth.role() = 'authenticated');
create policy "Users can update their own avatar." on storage.objects for update using (bucket_id = 'avatars' and auth.role() = 'authenticated');
```

## 🔐 认证系统

### 1. 认证提供者配置
在 Supabase Dashboard 中启用：
- Email 认证
- GitHub OAuth（可选）
- Google OAuth（可选）

### 2. 认证组件
创建 `src/components/auth/AuthButton.tsx`：
```typescript
'use client'

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { useRouter } from 'next/navigation'
import { useState } from 'react'

export default function AuthButton() {
  const router = useRouter()
  const supabase = createClientComponentClient()
  const [loading, setLoading] = useState(false)

  const handleSignOut = async () => {
    setLoading(true)
    await supabase.auth.signOut()
    router.refresh()
  }

  return (
    <button
      onClick={handleSignOut}
      disabled={loading}
      className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50"
    >
      {loading ? 'Signing out...' : 'Sign out'}
    </button>
  )
}
```

创建 `src/components/auth/AuthForm.tsx`：
```typescript
'use client'

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function AuthForm() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [isSignUp, setIsSignUp] = useState(false)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const router = useRouter()
  const supabase = createClientComponentClient()

  const handleAuth = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError(null)

    try {
      if (isSignUp) {
        const { error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: `${window.location.origin}/auth/callback`,
          },
        })
        if (error) throw error
        setError('请检查邮箱确认注册')
      } else {
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        })
        if (error) throw error
        router.refresh()
      }
    } catch (error: any) {
      setError(error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded-lg shadow-md">
      <h2 className="text-2xl font-bold mb-6 text-center">
        {isSignUp ? '注册' : '登录'}
      </h2>

      <form onSubmit={handleAuth} className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">
            邮箱
          </label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">
            密码
          </label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
            required
            minLength={6}
          />
        </div>

        {error && (
          <div className="text-red-500 text-sm">{error}</div>
        )}

        <button
          type="submit"
          disabled={loading}
          className="w-full py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
        >
          {loading ? '处理中...' : isSignUp ? '注册' : '登录'}
        </button>
      </form>

      <div className="mt-4 text-center">
        <button
          onClick={() => setIsSignUp(!isSignUp)}
          className="text-blue-500 hover:text-blue-600"
        >
          {isSignUp ? '已有账户？点击登录' : '没有账户？点击注册'}
        </button>
      </div>
    </div>
  )
}
```

### 3. 认证中间件
创建 `src/middleware.ts`：
```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  const {
    data: { session },
  } = await supabase.auth.getSession()

  // 保护需要认证的路由
  if (req.nextUrl.pathname.startsWith('/dashboard') && !session) {
    return NextResponse.redirect(new URL('/auth', req.url))
  }

  // 已登录用户不能访问认证页面
  if (req.nextUrl.pathname.startsWith('/auth') && session) {
    return NextResponse.redirect(new URL('/dashboard', req.url))
  }

  return res
}

export const config = {
  matcher: ['/dashboard/:path*', '/auth/:path*']
}
```

## 📝 CRUD 操作

### 1. Todo 类型定义
创建 `src/types/todo.ts`：
```typescript
export interface Todo {
  id: number
  created_at: string
  user_id: string
  title: string
  description?: string
  is_complete: boolean
  priority: number
  due_date?: string
  tags: string[]
  updated_at: string
}

export interface TodoFormData {
  title: string
  description?: string
  priority: number
  due_date?: string
  tags: string[]
}

export interface TodoFilters {
  status?: 'all' | 'active' | 'completed'
  priority?: number
  tags?: string[]
  search?: string
}
```

### 2. Todo 操作 Hook
创建 `src/hooks/useTodos.ts`：
```typescript
'use client'

import { useState, useEffect } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Todo, TodoFormData, TodoFilters } from '@/types/todo'

export function useTodos() {
  const supabase = createClientComponentClient()
  const [todos, setTodos] = useState<Todo[]>([])
  const [loading, setLoading] = useState(true)
  const [filters, setFilters] = useState<TodoFilters>({})

  // 获取 Todos
  const fetchTodos = async () => {
    try {
      let query = supabase
        .from('todos')
        .select('*')
        .order('created_at', { ascending: false })

      // 应用过滤器
      if (filters.status === 'active') {
        query = query.eq('is_complete', false)
      } else if (filters.status === 'completed') {
        query = query.eq('is_complete', true)
      }

      if (filters.priority) {
        query = query.eq('priority', filters.priority)
      }

      if (filters.search) {
        query = query.ilike('title', `%${filters.search}%`)
      }

      if (filters.tags && filters.tags.length > 0) {
        query = query.contains('tags', filters.tags)
      }

      const { data, error } = await query

      if (error) throw error
      setTodos(data || [])
    } catch (error) {
      console.error('Error fetching todos:', error)
    } finally {
      setLoading(false)
    }
  }

  // 添加 Todo
  const addTodo = async (todoData: TodoFormData) => {
    try {
      const { data, error } = await supabase
        .from('todos')
        .insert({
          ...todoData,
          user_id: (await supabase.auth.getUser()).data.user?.id,
        })
        .select()
        .single()

      if (error) throw error
      setTodos(prev => [data, ...prev])
      return data
    } catch (error) {
      console.error('Error adding todo:', error)
      throw error
    }
  }

  // 更新 Todo
  const updateTodo = async (id: number, updates: Partial<Todo>) => {
    try {
      const { data, error } = await supabase
        .from('todos')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id)
        .select()
        .single()

      if (error) throw error
      setTodos(prev => prev.map(todo => todo.id === id ? data : todo))
      return data
    } catch (error) {
      console.error('Error updating todo:', error)
      throw error
    }
  }

  // 删除 Todo
  const deleteTodo = async (id: number) => {
    try {
      const { error } = await supabase
        .from('todos')
        .delete()
        .eq('id', id)

      if (error) throw error
      setTodos(prev => prev.filter(todo => todo.id !== id))
    } catch (error) {
      console.error('Error deleting todo:', error)
      throw error
    }
  }

  // 切换完成状态
  const toggleComplete = async (id: number, isComplete: boolean) => {
    await updateTodo(id, { is_complete: isComplete })
  }

  useEffect(() => {
    fetchTodos()
  }, [filters])

  // 实时订阅
  useEffect(() => {
    const channel = supabase
      .channel('todos')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'todos',
        },
        (payload) => {
          console.log('Change received!', payload)
          fetchTodos()
        }
      )
      .subscribe()

    return () => supabase.removeChannel(channel)
  }, [])

  return {
    todos,
    loading,
    filters,
    setFilters,
    addTodo,
    updateTodo,
    deleteTodo,
    toggleComplete,
    fetchTodos,
  }
}
```

### 3. Todo 组件
创建 `src/components/todos/TodoList.tsx`：
```typescript
'use client'

import { useTodos } from '@/hooks/useTodos'
import { TodoFilters } from '@/types/todo'
import TodoItem from './TodoItem'
import TodoForm from './TodoForm'
import FilterControls from './FilterControls'

export default function TodoList() {
  const { todos, loading, filters, setFilters, addTodo, updateTodo, deleteTodo, toggleComplete } = useTodos()

  if (loading) {
    return <div className="text-center py-8">加载中...</div>
  }

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-8">Todo 列表</h1>

      <div className="grid gap-8">
        {/* 添加 Todo 表单 */}
        <TodoForm onSubmit={addTodo} />

        {/* 过滤控件 */}
        <FilterControls filters={filters} onChange={setFilters} />

        {/* Todo 列表 */}
        <div className="space-y-4">
          {todos.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              暂无 Todo 项目
            </div>
          ) : (
            todos.map((todo) => (
              <TodoItem
                key={todo.id}
                todo={todo}
                onUpdate={updateTodo}
                onDelete={deleteTodo}
                onToggleComplete={toggleComplete}
              />
            ))
          )}
        </div>
      </div>
    </div>
  )
}
```

## 🔄 实时同步

### 1. 实时更新 Hook
创建 `src/hooks/useRealtime.ts`：
```typescript
'use client'

import { useEffect, useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { RealtimeChannel } from '@supabase/supabase-js'

export function useRealtime(channelName: string, table: string) {
  const supabase = createClientComponentClient()
  const [channel, setChannel] = useState<RealtimeChannel | null>(null)
  const [isConnected, setIsConnected] = useState(false)

  useEffect(() => {
    const newChannel = supabase
      .channel(channelName)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: table,
        },
        (payload) => {
          console.log(`Realtime update in ${table}:`, payload)
          // 这里可以触发自定义事件或更新状态
        }
      )
      .subscribe((status) => {
        setIsConnected(status === 'SUBSCRIBED')
      })

    setChannel(newChannel)

    return () => {
      if (newChannel) {
        supabase.removeChannel(newChannel)
      }
    }
  }, [channelName, table])

  const subscribeToEvent = (event: string, callback: (payload: any) => void) => {
    if (channel) {
      channel.on('postgres_changes', {
        event,
        schema: 'public',
        table,
      }, callback)
    }
  }

  return { channel, isConnected, subscribeToEvent }
}
```

## 🚀 部署配置

### 1. Vercel 部署
创建 `vercel.json`：
```json
{
  "build": {
    "env": {
      "NEXT_PUBLIC_SUPABASE_URL": "@supabase_url",
      "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase_anon_key"
    }
  },
  "functions": {
    "src/app/**/*.ts": {
      "maxDuration": 30
    }
  }
}
```

### 2. 环境变量设置
在 Vercel 中设置环境变量：
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

### 3. 构建和部署
```bash
# 本地构建测试
pnpm build

# 部署到 Vercel
vercel --prod
```

## 🔧 高级功能

### 1. 文件上传
```typescript
// 上传头像
async function uploadAvatar(file: File, userId: string) {
  const supabase = createClientComponentClient()

  const fileExt = file.name.split('.').pop()
  const fileName = `${userId}.${fileExt}`

  const { error } = await supabase.storage
    .from('avatars')
    .upload(fileName, file, { upsert: true })

  if (error) throw error

  const { data: { publicUrl } } = supabase.storage
    .from('avatars')
    .getPublicUrl(fileName)

  return publicUrl
}
```

### 2. 分页查询
```typescript
// 分页获取 Todos
async function fetchTodos(page = 1, limit = 10) {
  const supabase = createClientComponentClient()
  const from = (page - 1) * limit
  const to = from + limit - 1

  const { data, error, count } = await supabase
    .from('todos')
    .select('*', { count: 'exact' })
    .range(from, to)
    .order('created_at', { ascending: false })

  return { data, count, page, limit }
}
```

### 3. 搜索功能
```typescript
// 全文搜索
async function searchTodos(query: string) {
  const supabase = createClientComponentClient()

  const { data } = await supabase
    .from('todos')
    .select('*')
    .or(`title.ilike.%${query}%,description.ilike.%${query}%`)
    .order('created_at', { ascending: false })

  return data
}
```

## 🛠️ 故障排除

### 常见问题
1. **认证问题**：检查环境变量和 RLS 策略
2. **CORS 错误**：在 Supabase Dashboard 中配置正确的重定向 URL
3. **实时更新不工作**：确保启用了 Realtime 并检查 RLS 策略
4. **权限错误**：检查用户认证状态和 RLS 策略配置

### 调试技巧
```typescript
// 启用调试模式
const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    debug: process.env.NODE_ENV === 'development'
  }
})
```

## 📚 扩展阅读
- [Supabase 文档](https://supabase.com/docs)
- [Next.js App Router](https://nextjs.org/docs/app)
- [PostgreSQL 教程](https://www.postgresql.org/docs/)

---

**最后更新**: 2025-10-17
**版本**: 1.0.0