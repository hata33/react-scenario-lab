# Next.js + Supabase Todo ç³»ç»Ÿå®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
2. [é¡¹ç›®åˆå§‹åŒ–](#é¡¹ç›®åˆå§‹åŒ–)
3. [Supabase é…ç½®](#supabase-é…ç½®)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [è®¤è¯ç³»ç»Ÿ](#è®¤è¯ç³»ç»Ÿ)
6. [CRUD æ“ä½œ](#crud-æ“ä½œ)
7. [å®æ—¶åŒæ­¥](#å®æ—¶åŒæ­¥)
8. [éƒ¨ç½²é…ç½®](#éƒ¨ç½²é…ç½®)

## ğŸš€ ç¯å¢ƒå‡†å¤‡

### å¿…éœ€æ¡ä»¶
- Node.js 18+
- pnpm åŒ…ç®¡ç†å™¨
- Supabase è´¦æˆ·
- Vercel è´¦æˆ·ï¼ˆæ¨èéƒ¨ç½²ï¼‰

### ä¾èµ–åŒ…å®‰è£…
```bash
# æ ¸å¿ƒä¾èµ–
pnpm add @supabase/supabase-js @supabase/ssr @supabase/auth-ui-react @supabase/auth-ui-shared

# ç±»å‹å®šä¹‰
pnpm add -D @types/node

# é¢å¤–å·¥å…·ï¼ˆå¯é€‰ï¼‰
pnpm add @supabase/postgrest-js
```

## ğŸ—ï¸ é¡¹ç›®åˆå§‹åŒ–

### 1. åˆ›å»º Next.js é¡¹ç›®
```bash
pnpm create next-app@latest my-supabase-todo --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
cd my-supabase-todo
```

### 2. ç¯å¢ƒå˜é‡é…ç½®
åˆ›å»º `.env.local` æ–‡ä»¶ï¼š
```env
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# è®¤è¯é…ç½®
NEXT_PUBLIC_SUPABASE_REDIRECT_URL=http://localhost:3000/auth/callback
```

### 3. Supabase å®¢æˆ·ç«¯é…ç½®
åˆ›å»º `src/lib/supabase.ts`ï¼š
```typescript
import { createClient } from '@supabase/supabase-js'
import { cookies } from 'next/headers'

// å®¢æˆ·ç«¯ç»„ä»¶ä½¿ç”¨
export function createClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// æœåŠ¡ç«¯ç»„ä»¶ä½¿ç”¨
export async function createServerClient() {
  const cookieStore = cookies()
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
      },
    }
  )
}

// ç›´æ¥å¯¼å‡ºï¼ˆå…¼å®¹æ€§ï¼‰
export const supabase = createClient()
```

## ğŸ—„ï¸ Supabase é…ç½®

### 1. æ•°æ®åº“è¡¨è®¾è®¡
åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œï¼š

```sql
-- ç”¨æˆ·è¡¨
create table profiles (
  id uuid references auth.users not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  website text,
  constraint username_length check (char_length(username) >= 3)
);

-- Todo è¡¨
create table todos (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  user_id uuid references auth.users not null,
  title text not null,
  description text,
  is_complete boolean default false,
  priority integer default 1 check (priority between 1 and 5),
  due_date timestamp with time zone,
  tags text[],
  updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- è®¾ç½® RLS (Row Level Security)
alter table profiles enable row level security;
alter table todos enable row level security;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
create policy "Users can view own profile." on profiles for select using (auth.uid() = id);
create policy "Users can update own profile." on profiles for update using (auth.uid() = id);

create policy "Users can view own todos." on todos for select using (auth.uid() = user_id);
create policy "Users can insert own todos." on todos for insert with check (auth.uid() = user_id);
create policy "Users can update own todos." on todos for update using (auth.uid() = user_id);
create policy "Users can delete own todos." on todos for delete using (auth.uid() = user_id);

-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
create index on todos (user_id, is_complete);
create index on todos (due_date);
create index on todos (created_at);
```

### 2. å­˜å‚¨æ¡¶é…ç½®ï¼ˆç”¨äºå¤´åƒä¸Šä¼ ï¼‰
```sql
-- åˆ›å»ºå¤´åƒå­˜å‚¨æ¡¶
insert into storage.buckets (id, name, public)
values ('avatars', 'avatars', true);

-- è®¾ç½®å¤´åƒä¸Šä¼ æƒé™
create policy "Avatar images are publicly accessible." on storage.objects for select using (bucket_id = 'avatars');
create policy "Users can upload their own avatar." on storage.objects for insert with check (bucket_id = 'avatars' and auth.role() = 'authenticated');
create policy "Users can update their own avatar." on storage.objects for update using (bucket_id = 'avatars' and auth.role() = 'authenticated');
```

## ğŸ” è®¤è¯ç³»ç»Ÿ

### 1. è®¤è¯æä¾›è€…é…ç½®
åœ¨ Supabase Dashboard ä¸­å¯ç”¨ï¼š
- Email è®¤è¯
- GitHub OAuthï¼ˆå¯é€‰ï¼‰
- Google OAuthï¼ˆå¯é€‰ï¼‰

### 2. è®¤è¯ç»„ä»¶
åˆ›å»º `src/components/auth/AuthButton.tsx`ï¼š
```typescript
'use client'

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { useRouter } from 'next/navigation'
import { useState } from 'react'

export default function AuthButton() {
  const router = useRouter()
  const supabase = createClientComponentClient()
  const [loading, setLoading] = useState(false)

  const handleSignOut = async () => {
    setLoading(true)
    await supabase.auth.signOut()
    router.refresh()
  }

  return (
    <button
      onClick={handleSignOut}
      disabled={loading}
      className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50"
    >
      {loading ? 'Signing out...' : 'Sign out'}
    </button>
  )
}
```

åˆ›å»º `src/components/auth/AuthForm.tsx`ï¼š
```typescript
'use client'

import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function AuthForm() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [isSignUp, setIsSignUp] = useState(false)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const router = useRouter()
  const supabase = createClientComponentClient()

  const handleAuth = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    setError(null)

    try {
      if (isSignUp) {
        const { error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: `${window.location.origin}/auth/callback`,
          },
        })
        if (error) throw error
        setError('è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤æ³¨å†Œ')
      } else {
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        })
        if (error) throw error
        router.refresh()
      }
    } catch (error: any) {
      setError(error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded-lg shadow-md">
      <h2 className="text-2xl font-bold mb-6 text-center">
        {isSignUp ? 'æ³¨å†Œ' : 'ç™»å½•'}
      </h2>

      <form onSubmit={handleAuth} className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">
            é‚®ç®±
          </label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
            required
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">
            å¯†ç 
          </label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
            required
            minLength={6}
          />
        </div>

        {error && (
          <div className="text-red-500 text-sm">{error}</div>
        )}

        <button
          type="submit"
          disabled={loading}
          className="w-full py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50"
        >
          {loading ? 'å¤„ç†ä¸­...' : isSignUp ? 'æ³¨å†Œ' : 'ç™»å½•'}
        </button>
      </form>

      <div className="mt-4 text-center">
        <button
          onClick={() => setIsSignUp(!isSignUp)}
          className="text-blue-500 hover:text-blue-600"
        >
          {isSignUp ? 'å·²æœ‰è´¦æˆ·ï¼Ÿç‚¹å‡»ç™»å½•' : 'æ²¡æœ‰è´¦æˆ·ï¼Ÿç‚¹å‡»æ³¨å†Œ'}
        </button>
      </div>
    </div>
  )
}
```

### 3. è®¤è¯ä¸­é—´ä»¶
åˆ›å»º `src/middleware.ts`ï¼š
```typescript
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(req: NextRequest) {
  const res = NextResponse.next()
  const supabase = createMiddlewareClient({ req, res })

  const {
    data: { session },
  } = await supabase.auth.getSession()

  // ä¿æŠ¤éœ€è¦è®¤è¯çš„è·¯ç”±
  if (req.nextUrl.pathname.startsWith('/dashboard') && !session) {
    return NextResponse.redirect(new URL('/auth', req.url))
  }

  // å·²ç™»å½•ç”¨æˆ·ä¸èƒ½è®¿é—®è®¤è¯é¡µé¢
  if (req.nextUrl.pathname.startsWith('/auth') && session) {
    return NextResponse.redirect(new URL('/dashboard', req.url))
  }

  return res
}

export const config = {
  matcher: ['/dashboard/:path*', '/auth/:path*']
}
```

## ğŸ“ CRUD æ“ä½œ

### 1. Todo ç±»å‹å®šä¹‰
åˆ›å»º `src/types/todo.ts`ï¼š
```typescript
export interface Todo {
  id: number
  created_at: string
  user_id: string
  title: string
  description?: string
  is_complete: boolean
  priority: number
  due_date?: string
  tags: string[]
  updated_at: string
}

export interface TodoFormData {
  title: string
  description?: string
  priority: number
  due_date?: string
  tags: string[]
}

export interface TodoFilters {
  status?: 'all' | 'active' | 'completed'
  priority?: number
  tags?: string[]
  search?: string
}
```

### 2. Todo æ“ä½œ Hook
åˆ›å»º `src/hooks/useTodos.ts`ï¼š
```typescript
'use client'

import { useState, useEffect } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Todo, TodoFormData, TodoFilters } from '@/types/todo'

export function useTodos() {
  const supabase = createClientComponentClient()
  const [todos, setTodos] = useState<Todo[]>([])
  const [loading, setLoading] = useState(true)
  const [filters, setFilters] = useState<TodoFilters>({})

  // è·å– Todos
  const fetchTodos = async () => {
    try {
      let query = supabase
        .from('todos')
        .select('*')
        .order('created_at', { ascending: false })

      // åº”ç”¨è¿‡æ»¤å™¨
      if (filters.status === 'active') {
        query = query.eq('is_complete', false)
      } else if (filters.status === 'completed') {
        query = query.eq('is_complete', true)
      }

      if (filters.priority) {
        query = query.eq('priority', filters.priority)
      }

      if (filters.search) {
        query = query.ilike('title', `%${filters.search}%`)
      }

      if (filters.tags && filters.tags.length > 0) {
        query = query.contains('tags', filters.tags)
      }

      const { data, error } = await query

      if (error) throw error
      setTodos(data || [])
    } catch (error) {
      console.error('Error fetching todos:', error)
    } finally {
      setLoading(false)
    }
  }

  // æ·»åŠ  Todo
  const addTodo = async (todoData: TodoFormData) => {
    try {
      const { data, error } = await supabase
        .from('todos')
        .insert({
          ...todoData,
          user_id: (await supabase.auth.getUser()).data.user?.id,
        })
        .select()
        .single()

      if (error) throw error
      setTodos(prev => [data, ...prev])
      return data
    } catch (error) {
      console.error('Error adding todo:', error)
      throw error
    }
  }

  // æ›´æ–° Todo
  const updateTodo = async (id: number, updates: Partial<Todo>) => {
    try {
      const { data, error } = await supabase
        .from('todos')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id)
        .select()
        .single()

      if (error) throw error
      setTodos(prev => prev.map(todo => todo.id === id ? data : todo))
      return data
    } catch (error) {
      console.error('Error updating todo:', error)
      throw error
    }
  }

  // åˆ é™¤ Todo
  const deleteTodo = async (id: number) => {
    try {
      const { error } = await supabase
        .from('todos')
        .delete()
        .eq('id', id)

      if (error) throw error
      setTodos(prev => prev.filter(todo => todo.id !== id))
    } catch (error) {
      console.error('Error deleting todo:', error)
      throw error
    }
  }

  // åˆ‡æ¢å®ŒæˆçŠ¶æ€
  const toggleComplete = async (id: number, isComplete: boolean) => {
    await updateTodo(id, { is_complete: isComplete })
  }

  useEffect(() => {
    fetchTodos()
  }, [filters])

  // å®æ—¶è®¢é˜…
  useEffect(() => {
    const channel = supabase
      .channel('todos')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'todos',
        },
        (payload) => {
          console.log('Change received!', payload)
          fetchTodos()
        }
      )
      .subscribe()

    return () => supabase.removeChannel(channel)
  }, [])

  return {
    todos,
    loading,
    filters,
    setFilters,
    addTodo,
    updateTodo,
    deleteTodo,
    toggleComplete,
    fetchTodos,
  }
}
```

### 3. Todo ç»„ä»¶
åˆ›å»º `src/components/todos/TodoList.tsx`ï¼š
```typescript
'use client'

import { useTodos } from '@/hooks/useTodos'
import { TodoFilters } from '@/types/todo'
import TodoItem from './TodoItem'
import TodoForm from './TodoForm'
import FilterControls from './FilterControls'

export default function TodoList() {
  const { todos, loading, filters, setFilters, addTodo, updateTodo, deleteTodo, toggleComplete } = useTodos()

  if (loading) {
    return <div className="text-center py-8">åŠ è½½ä¸­...</div>
  }

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-8">Todo åˆ—è¡¨</h1>

      <div className="grid gap-8">
        {/* æ·»åŠ  Todo è¡¨å• */}
        <TodoForm onSubmit={addTodo} />

        {/* è¿‡æ»¤æ§ä»¶ */}
        <FilterControls filters={filters} onChange={setFilters} />

        {/* Todo åˆ—è¡¨ */}
        <div className="space-y-4">
          {todos.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              æš‚æ—  Todo é¡¹ç›®
            </div>
          ) : (
            todos.map((todo) => (
              <TodoItem
                key={todo.id}
                todo={todo}
                onUpdate={updateTodo}
                onDelete={deleteTodo}
                onToggleComplete={toggleComplete}
              />
            ))
          )}
        </div>
      </div>
    </div>
  )
}
```

## ğŸ”„ å®æ—¶åŒæ­¥

### 1. å®æ—¶æ›´æ–° Hook
åˆ›å»º `src/hooks/useRealtime.ts`ï¼š
```typescript
'use client'

import { useEffect, useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { RealtimeChannel } from '@supabase/supabase-js'

export function useRealtime(channelName: string, table: string) {
  const supabase = createClientComponentClient()
  const [channel, setChannel] = useState<RealtimeChannel | null>(null)
  const [isConnected, setIsConnected] = useState(false)

  useEffect(() => {
    const newChannel = supabase
      .channel(channelName)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: table,
        },
        (payload) => {
          console.log(`Realtime update in ${table}:`, payload)
          // è¿™é‡Œå¯ä»¥è§¦å‘è‡ªå®šä¹‰äº‹ä»¶æˆ–æ›´æ–°çŠ¶æ€
        }
      )
      .subscribe((status) => {
        setIsConnected(status === 'SUBSCRIBED')
      })

    setChannel(newChannel)

    return () => {
      if (newChannel) {
        supabase.removeChannel(newChannel)
      }
    }
  }, [channelName, table])

  const subscribeToEvent = (event: string, callback: (payload: any) => void) => {
    if (channel) {
      channel.on('postgres_changes', {
        event,
        schema: 'public',
        table,
      }, callback)
    }
  }

  return { channel, isConnected, subscribeToEvent }
}
```

## ğŸš€ éƒ¨ç½²é…ç½®

### 1. Vercel éƒ¨ç½²
åˆ›å»º `vercel.json`ï¼š
```json
{
  "build": {
    "env": {
      "NEXT_PUBLIC_SUPABASE_URL": "@supabase_url",
      "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase_anon_key"
    }
  },
  "functions": {
    "src/app/**/*.ts": {
      "maxDuration": 30
    }
  }
}
```

### 2. ç¯å¢ƒå˜é‡è®¾ç½®
åœ¨ Vercel ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

### 3. æ„å»ºå’Œéƒ¨ç½²
```bash
# æœ¬åœ°æ„å»ºæµ‹è¯•
pnpm build

# éƒ¨ç½²åˆ° Vercel
vercel --prod
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. æ–‡ä»¶ä¸Šä¼ 
```typescript
// ä¸Šä¼ å¤´åƒ
async function uploadAvatar(file: File, userId: string) {
  const supabase = createClientComponentClient()

  const fileExt = file.name.split('.').pop()
  const fileName = `${userId}.${fileExt}`

  const { error } = await supabase.storage
    .from('avatars')
    .upload(fileName, file, { upsert: true })

  if (error) throw error

  const { data: { publicUrl } } = supabase.storage
    .from('avatars')
    .getPublicUrl(fileName)

  return publicUrl
}
```

### 2. åˆ†é¡µæŸ¥è¯¢
```typescript
// åˆ†é¡µè·å– Todos
async function fetchTodos(page = 1, limit = 10) {
  const supabase = createClientComponentClient()
  const from = (page - 1) * limit
  const to = from + limit - 1

  const { data, error, count } = await supabase
    .from('todos')
    .select('*', { count: 'exact' })
    .range(from, to)
    .order('created_at', { ascending: false })

  return { data, count, page, limit }
}
```

### 3. æœç´¢åŠŸèƒ½
```typescript
// å…¨æ–‡æœç´¢
async function searchTodos(query: string) {
  const supabase = createClientComponentClient()

  const { data } = await supabase
    .from('todos')
    .select('*')
    .or(`title.ilike.%${query}%,description.ilike.%${query}%`)
    .order('created_at', { ascending: false })

  return data
}
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **è®¤è¯é—®é¢˜**ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡å’Œ RLS ç­–ç•¥
2. **CORS é”™è¯¯**ï¼šåœ¨ Supabase Dashboard ä¸­é…ç½®æ­£ç¡®çš„é‡å®šå‘ URL
3. **å®æ—¶æ›´æ–°ä¸å·¥ä½œ**ï¼šç¡®ä¿å¯ç”¨äº† Realtime å¹¶æ£€æŸ¥ RLS ç­–ç•¥
4. **æƒé™é”™è¯¯**ï¼šæ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€å’Œ RLS ç­–ç•¥é…ç½®

### è°ƒè¯•æŠ€å·§
```typescript
// å¯ç”¨è°ƒè¯•æ¨¡å¼
const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    debug: process.env.NODE_ENV === 'development'
  }
})
```

## ğŸ“š æ‰©å±•é˜…è¯»
- [Supabase æ–‡æ¡£](https://supabase.com/docs)
- [Next.js App Router](https://nextjs.org/docs/app)
- [PostgreSQL æ•™ç¨‹](https://www.postgresql.org/docs/)

---

**æœ€åæ›´æ–°**: 2025-10-17
**ç‰ˆæœ¬**: 1.0.0